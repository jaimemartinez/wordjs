# Production Deployment Guide üöÄ

WordJS is designed to be easy to deploy. It defaults to a file-based **SQLite** database for zero-config startups, but fully supports **PostgreSQL** for high-scale external database needs.

---

## üìã Prerequisites

- **Node.js:** v18 or higher.
- **PM2:** (Recommended) A process manager for Node.js to keep your app alive.
  ```bash
  npm install -g pm2
  ```

---

## üõ†Ô∏è Installation Steps

### 1. Clone & Install
```bash
git clone <your-repo-url>
cd wordjs
npm install
cd backend && npm install
cd ../admin-next && npm install
```

### 2. Build the Frontend
The frontend must be compiled for production to ensure maximum speed.
```bash
cd admin-next
npm run build
cd ..
```

### 3. Build Plugin Frontends (NEW)
WordJS uses a hybrid system. In production, plugins load frontend code from pre-compiled bundles. You must compile them once before starting.
```bash
cd backend
node scripts/build-plugin.js --all
cd ..
```

### 4. Configure the Site
You have two options for production:

**A. Using the Interactive Installer (Default)**
1. Start the app (see "Run in Production").
2. The server will detect that `wordjs-config.json` is missing and start in **Setup Mode**.
3. Visit your server's IP/Domain (e.g., `http://localhost:3000`).
4. You will be redirected to the installation screen to set up your admin account and site details.

**B. Using Configuration File (Recommended)**
All configuration is handled via `wordjs-config.json` in the `backend` directory.

Example `backend/wordjs-config.json`:
```json
{
  "siteUrl": "https://my-site.com",
  "frontendUrl": "https://my-site.com",
  "port": 4000,
  "gatewayPort": 3000,
  "jwtSecret": "auto-generated-secure-secret",
  "gatewaySecret": "auto-generated-secure-secret",
  "nodeEnv": "production"
}
```

---

## üèÉ Run in Production

We recommend using **PM2** to manage the three components (Gateway, Backend, Frontend).

### A. Automatic (using concurrently)
You can use the root script but it's less granular for logs:
```bash
pm2 start "npm start" --name wordjs
```

### B. Granular (Recommended)
This allows you to restart individual services if needed.

```bash
# Start Gateway
pm2 start gateway.js --name "wordjs-gateway"

# Start Backend
cd backend
pm2 start src/index.js --name "wordjs-backend"

# Start Frontend
cd ../admin-next
pm2 start "npm run start -- -p 3001" --name "wordjs-frontend"
```

---

## üîí Security Checklist

1.  **Firewall:** Only open port `3000` (Gateway) to the public. Ports `4000` (Backend) and `3001` (Frontend) should stay internal.
2.  **HTTPS:** Use a service like **Cloudflare** or a simple **Nginx Reverse Proxy** on top of the Gateway to handle SSL (Certbot).
3.  **Secrets:** Ensure your `gatewaySecret` and `jwtSecret` in `wordjs-config.json` are cryptographically secure (auto-generated by the installer).

---

## üîÑ Updates

To update the CMS:
```bash
git pull
npm install
cd admin-next && npm install && npm run build
cd ../backend && npm install && node scripts/build-plugin.js --all
pm2 restart all
```

---

## üåê Domain Migration

When migrating WordJS to a new domain, keep these important considerations in mind:

### SSL Certificates (Self-Signed)

If you are using **self-signed certificates** (`ssl-auto.crt` and `ssl-auto.key`), you **must regenerate** them for the new domain. Self-signed certificates are bound to the domain they were created for, and the browser will reject connections if there's a mismatch.

To regenerate a self-signed certificate:
```bash
# Generate new self-signed certificate for new domain
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout ssl-auto.key \
  -out ssl-auto.crt \
  -subj "/CN=your-new-domain.com"
```

Alternatively, use the **Admin Panel ‚Üí Security ‚Üí SSL Certificate Manager** to provision a new Let's Encrypt certificate for the new domain.

### Media URLs (Important!)

WordJS stores media URLs as **relative paths** (e.g., `/uploads/image.jpg`) rather than absolute URLs (e.g., `https://old-domain.com/uploads/image.jpg`). This is by design to ensure:

- ‚úÖ **Seamless migration** ‚Äî No database updates needed when changing domains
- ‚úÖ **Multi-environment support** ‚Äî Same database works in dev/staging/production
- ‚úÖ **CDN flexibility** ‚Äî Easy to add or change CDN prefixes

If you have legacy content with absolute URLs, you may need to run a migration script to convert them to relative paths.

### Migration Checklist

1. [ ] Update `siteUrl` and `frontendUrl` in `wordjs-config.json`
2. [ ] Regenerate SSL certificate if using self-signed
3. [ ] Update DNS records to point to the new server (if applicable)
4. [ ] Verify media URLs are relative (not absolute)
5. [ ] Clear any CDN or browser caches
6. [ ] Test all functionality on the new domain
