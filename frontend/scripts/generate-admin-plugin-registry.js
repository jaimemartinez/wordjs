/**
 * generate-admin-plugin-registry.js
 * 
 * Generates the admin plugin registry for dynamic routes.
 * Maps plugin slugs to their admin page component paths.
 * 
 * READS FROM: Each plugin's manifest.json
 * NO HARDCODED PLUGIN CONFIGURATIONS
 */

const fs = require('fs');
const path = require('path');
const http = require('http');

const PLUGINS_DIR = path.resolve(__dirname, '../../backend/plugins');
const OUTPUT_FILE = path.resolve(__dirname, '../src/app/admin/plugin/[slug]/page.tsx');
const API_URL = 'http://localhost:3000/api/v1/plugins/active';

/**
 * Fetch active plugins from backend API
 */
function fetchActivePlugins() {
    return new Promise((resolve) => {
        http.get(API_URL, (res) => {
            let data = '';
            res.on('data', chunk => data += chunk);
            res.on('end', () => {
                try {
                    resolve(JSON.parse(data));
                } catch {
                    console.log('   ‚ö†Ô∏è  API not available, including all existing plugins');
                    resolve(null);
                }
            });
        }).on('error', () => {
            console.log('   ‚ö†Ô∏è  Backend not running, including all existing plugins');
            resolve(null);
        });
    });
}

/**
 * Discover plugins with admin pages from manifest.json
 */
function discoverPluginsWithAdmin() {
    const plugins = [];

    if (!fs.existsSync(PLUGINS_DIR)) {
        return plugins;
    }

    const folders = fs.readdirSync(PLUGINS_DIR, { withFileTypes: true })
        .filter(d => d.isDirectory())
        .map(d => d.name);

    for (const folder of folders) {
        const manifestPath = path.join(PLUGINS_DIR, folder, 'manifest.json');

        if (!fs.existsSync(manifestPath)) {
            continue;
        }

        try {
            const manifest = JSON.parse(fs.readFileSync(manifestPath, 'utf8'));

            // Check if plugin has admin page defined in manifest
            const adminPage = manifest.frontend?.adminPage;
            if (!adminPage?.entry || !adminPage?.slug) {
                continue;
            }

            // Verify admin page file exists
            const adminPath = adminPage.entry.replace('./', '').replace('.tsx', '');
            const fullPath = path.join(PLUGINS_DIR, folder, adminPage.entry.replace('./', ''));

            if (!fs.existsSync(fullPath)) {
                console.log(`   ‚úó Admin page not found: ${folder} (${adminPage.entry})`);
                continue;
            }

            plugins.push({
                id: manifest.id || folder,
                folder: folder,
                adminSlug: adminPage.slug,
                adminPath: adminPath,
            });

        } catch (err) {
            console.log(`   ‚úó Invalid manifest: ${folder} - ${err.message}`);
        }
    }

    return plugins;
}

async function generateAdminRegistry() {
    console.log('üìã Generating admin plugin registry from manifests...');

    // Discover all plugins with admin pages
    const allPlugins = discoverPluginsWithAdmin();
    console.log(`   Found ${allPlugins.length} plugin(s) with admin pages`);

    // Fetch active plugins from API
    const fetched = await fetchActivePlugins();
    const filterByActive = Array.isArray(fetched);
    const activeList = filterByActive ? fetched : [];

    if (filterByActive) {
        console.log(`   Active from API: ${activeList.join(', ') || 'none'}`);
    } else {
        console.log('   ‚ö†Ô∏è  Filtering disabled (API unavailable or invalid response)');
    }

    // Filter to only active plugins
    const availablePlugins = allPlugins.filter(p => {
        if (filterByActive && !activeList.includes(p.id)) {
            console.log(`   ‚óã Inactive: ${p.id}`);
            return false;
        }
        console.log(`   ‚úì Included: ${p.adminSlug} -> ${p.id}`);
        return true;
    });

    // Generate imports
    const imports = availablePlugins.map(p =>
        `    "${p.adminSlug}": () => import("../../../../../../backend/plugins/${p.folder}/${p.adminPath}"),`
    ).join('\n');

    const content = `"use client";

/**
 * AUTO-GENERATED FILE - Do not edit directly!
 * 
 * Generated by: scripts/generate-admin-plugin-registry.js
 * Generated at: ${new Date().toISOString()}
 * 
 * Plugin info is read from each plugin's manifest.json
 */

import dynamic from "next/dynamic";
import { useParams } from "next/navigation";
import { Suspense } from "react";

const PLUGIN_ADMIN_PAGES: Record<string, () => Promise<any>> = {
${imports}
};

function LoadingFallback() {
    return (
        <div className="p-8 flex items-center justify-center">
            <div className="text-center">
                <div className="inline-block w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                <p className="text-gray-500">Loading plugin...</p>
            </div>
        </div>
    );
}

function PluginNotFound({ slug }: { slug: string }) {
    return (
        <div className="p-8 text-center">
            <div className="text-6xl mb-4">üîå</div>
            <h1 className="text-2xl font-bold text-gray-800 mb-2">Plugin Not Found</h1>
            <p className="text-gray-600 mb-4">
                The plugin <code className="bg-gray-100 px-2 py-1 rounded">{slug}</code> is not installed.
            </p>
            <a href="/admin/plugins" className="text-blue-600 hover:underline">
                ‚Üê Back to Plugins
            </a>
        </div>
    );
}

export default function PluginAdminPage() {
    const params = useParams();
    const slug = params.slug as string;

    if (!PLUGIN_ADMIN_PAGES[slug]) {
        return <PluginNotFound slug={slug} />;
    }

    const PluginPage = dynamic(
        () => PLUGIN_ADMIN_PAGES[slug]().catch(() => ({
            default: () => <PluginNotFound slug={slug} />
        })),
        { loading: () => <LoadingFallback />, ssr: false }
    );

    return (
        <Suspense fallback={<LoadingFallback />}>
            <PluginPage />
        </Suspense>
    );
}
`;

    fs.writeFileSync(OUTPUT_FILE, content, 'utf8');
    console.log(`\n‚úÖ Admin registry generated with ${availablePlugins.length} plugin(s)`);
}

generateAdminRegistry();
